@model CardAuction.Models.tAuctionItem
@using CardAuction.Models
@{
    ViewBag.Title = "競標商品";
    Layout = "~/Views/Shared/_Layout.cshtml";
    string filepath0 = Model.fPhoto0;
    string filepath1 = Model.fPhoto1;
    string filepath2 = Model.fPhoto2;
    string filepath3 = Model.fPhoto3;
    int leastBid = Model.fMoneyNow + Model.fMoneyStep;
    int secondTotalRemain = Convert.ToInt32((Model.fEndTime - DateTime.Now).TotalSeconds);

}

@section styles{
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css" integrity="sha512-10/jx2EXwxxWqCLX/hHth/vu2KY3jCF70dCQB8TSgNjbCVAC/8vai53GfMDrO2Emgwccf2pJqxct9ehpzG+MTw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="~/Content/Bootstrap/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="~/Content/AuctionCss/cssAuctionItem.css" type="text/css" />
}
<div class="container">
    <div class="mt-5" id="divMainContent">
        <div class="mb-3" id="divSort">
            競標 / @Model.fSort
        </div>        
        <div class="row">
            <div class="col-xs-12 col-sm-12 col-md-6" id="divItemName">
                @Model.fItemName
            </div>

                
            <div class="col-sm-12 col-md-6 container" id="divButtons">
                <div class="row">

                    <div class="col-4">
                        <button id="btnComment"><i class="fa-solid fa-comments"></i> 聯絡賣家</button>
                    </div>

                    <div class="col-4">
                        <button class="notFollowing" id="btnFavorite"><i id="iconFavorite" class="fa-solid fa-heart-circle-plus"></i> <span id="txtFavorite">加入追蹤</span></button>
                    </div>

                    <div class="col-4">
                        <button id="btnReport"><i class="fa-solid fa-triangle-exclamation"></i> 檢舉</button>
                    </div>

                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-md-6" id="divPhoto">
                    <div>
                        <img src="~/Images/AuctionItemImages/@filepath0" id="imgShow" /><br />
                    </div>
                    <div id="divSmallList">
                        @{
                            if (Model.fPhoto0 != null)
                            {
                                <img src="~/Images/AuctionItemImages/@filepath0" class="imgSmall imgOut" id="imgSmall0" />
                            }
                            if (Model.fPhoto1 != null)
                            {
                                <img src="~/Images/AuctionItemImages/@filepath1" class="imgSmall imgOut" id="imgSmall1" />
                            }
                            if (Model.fPhoto2 != null)
                            {
                                <img src="~/Images/AuctionItemImages/@filepath2" class="imgSmall imgOut" id="imgSmall2" />
                            }
                            if (Model.fPhoto3 != null)
                            {
                                <img src="~/Images/AuctionItemImages/@filepath3" class="imgSmall imgOut" id="imgSmall3" />
                            }
                        }
                    </div>
                </div>
                <div class="col-sm-12 col-md-6" id="divBidInfo">
                    <div id="divTime">
                        <div id="divClock">
                            <img src="~/Images/site/iconClock.png" id="imgClock" />
                        </div>
                        <div id="divStamp">
                            <span id="stampTime"></span>
                        </div>
                        <div id="divCalender">
                            加入行事曆
                        </div>
                    </div>
                    <div class="container" id="divMoney">
                        @if (Model.fBuyPrice > -1)
                        {
                            <div class="row moneyRow rowBuy">
                                <div class="col-3 titleMoney">
                                    直購價
                                </div>
                                <div class="col-6 goldMoney">
                                    $ @Model.fBuyPrice 元
                                </div>
                                <div class="col-3" id="divBtnBuy">
                                    <button id="btnBuy">購買</button>
                                </div>
                            </div>
                        }
                        <div class="row moneyRow">
                            <div class="col-3 titleMoney">
                                目前出價
                            </div>
                            <div class="col-9">
                                <span class="goldMoney" id="MoneyNow">$ @Model.fMoneyNow 元</span>
                            </div>
                        </div>
                        <div class="row moneyRow">
                            <div class="col-3 titleMoney">
                                出價增額
                            </div>
                            <div class="col-9">
                                <span class="goldMoney">$ @Model.fMoneyStep 元</span>
                            </div>
                        </div>
                        <div class="row moneyRow" id="divBid">
                            <div class="col-9" id="titleTextBox">
                                <input type="number" placeholder="請輸入出價上限" id="txtBid" step="1" min="@leastBid" />
                            </div>
                            <div class="col-3">
                                <button id="btnBid">出價</button>
                            </div>
                        </div>
                    </div>

                    <div class="row" id="divHistory">
                        <div class="row historyRecord">
                            <div class="col-4 historyAccount">
                                出價者
                            </div>
                            <div class="col-6 historyTime">
                                時間
                            </div>
                            <div class="col-2 historyMoney">
                                出價
                            </div>
                        </div>
                        <div id="bidHere">
                            <!-- big History here-->
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="row" id="divDescription">
                        <div class="col-6 col-sm-5 col-md-3 titleTopic">
                            商品說明
                        </div>
                        <div id="divDescriptContent">
                            <div class="mt-2 mb-4">鑑定公司： @Model.fGrading</div>
                            <div class="mb-4">賣家：@ViewBag.PostUserAccount</div>
                            <div class="mb-4">
                                @Model.fItemDescription
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="row" id="divComment">
                        <div class="col-6 col-sm-5 col-md-3 titleTopic">
                            留言
                        </div>
                        <div id="divCommentContent">

                        </div>
                        <div id="inputSend">
                            <div id="commentHere">
                                <!-- comment result -->
                            </div>

                            <div class="row commentRecord">
                                <div class="col-8 col-sm-8 col-md-10">
                                    <input type="text" id="txtComment" maxlength="100" />
                                </div>
                                <div class="col-2 col-sm-2 col-md-1" id="divCountComment">
                                    <span id="countComment">0/100</span>
                                </div>
                                <div class="col-2 col-sm-2 col-md-1">
                                    <button id="btnCommentSend">留言</button>
                                </div>
                            </div>







                        </div>
                    </div>
                </div>
                <div class="container">
                    <div class="row" id="divHistory">
                        <div class="col-6 col-sm-5 col-md-3 titleTopic">
                            歷史成交統計
                        </div>
                        <div id="divHistoryContent">
                            <br /><br /><br /><br />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section scripts{
    <script>


        var secondRemain = @secondTotalRemain ;
        var leastBid = @leastBid;
        var domTime = document.getElementById('stampTime');
        var btnBuy = document.getElementById('btnBuy');
        var btnBid = document.getElementById('btnBid');
        var txtBid = document.getElementById('txtBid');
        var domShow = document.getElementById('imgShow');
        var btnFavorite = document.getElementById('btnFavorite');
        var iconFavorite = document.getElementById('iconFavorite');
        var txtFavorite = document.getElementById('txtFavorite');
        var txtComment = document.getElementById('txtComment');
        var countComment = document.getElementById('countComment');
        var btnCommentSend = document.getElementById('btnCommentSend');
        var commentHere = document.getElementById('commentHere');
        var bidHere = document.getElementById('bidHere');


        var fItemId = '@Model.fItemId';

        var timer = window.setInterval(function () {
            secondRemain -= 7;
            refreshStampTime(secondRemain);
        }, 7000);

        function refreshStampTime(t) {
            if (t <= 0) {
                domTime.textContent = '競標已結束';
                clearInterval(timer);
                domBuy.setAttribute('disabled', 'true');
                domBid.setAttribute('disabled', 'true');
                domTxtBid.setAttribute('disabled', 'true');
                return;
            }
            let day = Math.floor(t / 86400);
            t %= 86400;
            let hr = Math.floor(t / 3600);
            t %= 3600;
            let min = Math.floor(t / 60);
            domTime.textContent = `${day} 天 ${hr} 時 ${min} 分 結束`;
        }
        document.querySelectorAll('.imgSmall').forEach(function (dom) {
            dom.addEventListener('mouseover', function () {
                this.classList.remove('imageOut');
                this.classList.add('imageHover');
                domShow.src = this.src;
            });
            dom.addEventListener('mouseleave', function () {
                this.classList.remove('imageHover');
                this.classList.add('imageOut');
            });
            dom.addEventListener('click', function () {
                this.classList.remove('imageOut');
                this.classList.add('imageHover');
                domShow.src = this.src;
            });
        });

        txtComment.addEventListener('keyup', function () {
            let letters = txtComment.value;
            countComment.textContent = `${letters.length}/100`;
        });

        refreshStampTime(secondRemain);
        @if(Session[CDictionary.SK_UserUserId] != null && Session[CDictionary.SK_UserUserId].ToString().Equals(Model.fPostUserId))
        {
        @:btnFavorite.disabled = true;
        @:btnBid.disabled = true;
        }


        @if (Session[CDictionary.SK_UserUserId] == null)
        {
            TempData[CDictionary.SK_RedirectToAction] = "Item";
            TempData[CDictionary.SK_RedirectToController] = "Auction";
            TempData[CDictionary.SK_RedirectToId] = Model.fItemId;

        @:btnFavorite.addEventListener('click', function (event) {
            @:event.preventDefault();
            @:location.href = '@Url.Content("~/Member/Login")';
        @:});

        @:btnBid.addEventListener('click', function () {
            @:location.href = '@Url.Content("~/Member/Login")';
        @:});

        @:btnCommentSend.addEventListener('click', function () {
            @:location.href = '@Url.Content("~/Member/Login")';
        @:});
        }
        else
        {
        @:btnFavorite.addEventListener('click', function (event) {
            @:event.preventDefault();
            @:let xhr = new XMLHttpRequest();
                @:xhr.addEventListener('load', function() {
                    @:let isFavorite = xhr.response;
                    @:toggleFavorite(isFavorite);
                @:});
            @:let para = `?ItemId=${fItemId}`;
            @:xhr.open('GET', '@Url.Content("~/Member/FavoriteAuction")' + para);
            @:xhr.send();
        @:});

        @:btnBid.addEventListener('click', function () {
            @:let amount = parseInt(txtBid.value);

            @:if (amount >= @leastBid) {
            @:    sendBid(amount);
            @:}
            @:txtBid.value = '';
            @:txtBid.focus();
        @:});

        @:btnCommentSend.addEventListener('click', function () {
            @:let content = txtComment.value;
            @:if (content != '') {
            @:    sendComment(content);
            @:}
            @:txtComment.value = '';
            @:countComment.textContent = '0/100';
            @:txtComment.focus();
        @:});
        }


        checkFavorite();
        receiveComments();
        receiveBidRecords();


        document.getElementById('btnComment').addEventListener('click', function () {
            location.href += '#divComment';
            txtComment.focus();
        });

        function sendBid(amount) {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener('load', receiveBidRecords);
            let para = `?itemId=${fItemId}&amount=${amount}`;
            xhr.open('GET', '@Url.Content("~/Auction/Bid")' + para);
            xhr.send();
        }

        function receiveBidRecords() {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener('load', function () {
                if (this.responseText != '') {
                    let datas = JSON.parse(this.responseText);
                    refreshBidRecord(datas);
                }
            });
            let para = `?itemId=${fItemId}`;
            xhr.open('GET', '@Url.Content("~/Auction/ReceiveBidRecords")' + para);
            xhr.send();
        }
        function sendComment(content) {
            let xhr = new XMLHttpRequest();
            let para = `?itemId=${fItemId}&message=${content}`;
            xhr.addEventListener('load', receiveComments);
            xhr.open('GET', '@Url.Content("~/Auction/WriteComment")' + para);
            xhr.send();
        };


        function receiveComments() {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener('load', function () {
                if (this.responseText != '') {
                    let datas = JSON.parse(this.responseText);
                    refreshComments(datas);
                }
            });
            let para = `?ItemId=${fItemId}`;
            xhr.open('GET', '@Url.Content("~/Auction/ReceiveComments")' + para);
            xhr.send();
        }

        function refreshBidRecord(datas) {

            bidHere.innerHTML = '';
            let docFrag = document.createDocumentFragment();
            for (let history of datas) {
                let historyTime = new Date(parseInt(history.bidTime.substr(6))).toLocaleString();
                let domRow = document.createElement('div');
                domRow.className = 'row historyRecord';
                let domAccount = document.createElement('div');
                domAccount.className = 'col-4 historyAccount';
                domAccount.textContent = history.bidAcc;
                let domTime = document.createElement('div');
                domTime.className = 'col-6 historyTime';
                domTime.textContent = historyTime;
                let domMoney = document.createElement('div');
                domMoney.className = 'col-2 historyMoney';
                domMoney.textContent = '$' + history.bidMoney;

                domRow.appendChild(domAccount);
                domRow.appendChild(domTime);
                domRow.appendChild(domMoney);

                docFrag.appendChild(domRow);
            }
            bidHere.appendChild(docFrag);
            document.getElementById('MoneyNow').textContent = '$ ' + datas[0].bidMoney + ' 元';

        }

        function refreshComments(datas) {
            commentHere.innerHTML = '';
            let docFrag = document.createDocumentFragment();

            for (let comment of datas) {
                let commentTime = new Date(parseInt(comment.postTime.substr(6))).toLocaleString();
                let domRow = document.createElement('div');
                domRow.className = 'row commentRecord';
                let domAccount = document.createElement('div');
                domAccount.className = 'col-6 col-sm-6 col-md-2 commentAccount';
                domAccount.textContent = comment.postAcc;
                let domContent = document.createElement('div');
                domContent.className = 'col-6 col-sm-12 col-md-8 commentContent';
                domContent.textContent = comment.content;
                let domTime = document.createElement('div');
                domTime.className = 'col-6 col-sm-6 col-md-2 commentTime';
                domTime.textContent = commentTime;
                domRow.appendChild(domAccount);
                domRow.appendChild(domContent);
                domRow.appendChild(domTime);

                docFrag.appendChild(domRow);
            }

            commentHere.appendChild(docFrag);

        }
        function checkFavorite() {
            let xhr = new XMLHttpRequest();
            xhr.addEventListener('load', function () {
                let isFavorite = xhr.response;
                toggleFavorite(isFavorite);

            });
            let para = `?ItemId=${fItemId}`;
            xhr.open('GET', '@Url.Content("~/Member/IsFavorite")' + para);
            xhr.send();
        };

        function toggleFavorite(isFavorite) {
            if (isFavorite == 'True') {

                txtFavorite.textContent = '已追蹤';
                iconFavorite.classList.add('fa-heart-circle-check');
                iconFavorite.classList.remove('fa-heart-circle-plus');
                btnFavorite.classList.add('following');
                btnFavorite.classList.remove('notFollowing');
            }
            else {
                txtFavorite.textContent = '加入追蹤';
                iconFavorite.classList.add('fa-heart-circle-plus');
                iconFavorite.classList.remove('fa-heart-circle-check');

                btnFavorite.classList.remove('following');
                btnFavorite.classList.add('notFollowing');
            }
        }

    </script>
}